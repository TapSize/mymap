<!DOCTYPE html>

<html lang="uk">
<head>
<meta charset="utf-8"/>
<title>Карта вертолітних майданчиків</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<style>
    html, body {
      margin: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1e1e1e;
    }
    #map { width: 100%; height: 100%; }

    .info-panel {
      position: absolute; top: 0; right: 0; width: 300px; height: 100%;
      background-color: rgba(0, 0, 0, 0.7); color: #fff;
      padding: 20px; overflow-y: auto; display: none; z-index: 1000;
    }
    .info-panel h2 { margin-top: 0; }
    .close-btn {
      width: 100%; background: #2a2a2a; color: #dddddd;
      border: none; border-top: 1px solid #444;
      padding: 12px 0; font-size: 16px; cursor: pointer; margin-top: 20px;
    }
    #helipadMiniMap {
      height: 200px; width: 100%;
      border-radius: 8px; margin-bottom: 10px;
    }

    #mapContextBtn {
      position: absolute; bottom: 20px; left: 20px;
      background: none; border: none; cursor: pointer;
      width: 40px; height: 40px;
      background-image: url('https://i.ibb.co/tTSG976d/Map-Change-removebg-preview-1.png');
      background-size: contain; background-repeat: no-repeat;
      z-index: 1100;
    }

    .minimal-black-menu {
      position: absolute; bottom: 70px; left: 20px;
      background: rgba(30, 30, 30, 0.95);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      display: none; flex-direction: column;
      padding: 8px 0;
      z-index: 1100;
      min-width: 160px;
    }

    .minimal-black-menu button {
      background: transparent;
      border: none;
      color: #f1f1f1;
      padding: 10px 16px;
      text-align: left;
      font-size: 14px;
      width: 100%;
      cursor: pointer;
    }

    .minimal-black-menu button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
  
@keyframes glow {
  0% { box-shadow: 0 0 0px #7cadd7; }
  50% { box-shadow: 0 0 12px #7cadd7; }
  100% { box-shadow: 0 0 0px #7cadd7; }
}
.leaflet-marker-icon.glow {
  animation: glow 2s infinite ease-in-out;
  border-radius: 50%;
}

#returnToLocationBtn {
  position: absolute;
  bottom: 70px;
  left: 20px;
  background: none;
  border: none;
  cursor: pointer;
  width: 40px;
  height: 40px;
  background-image: url('https://i.ibb.co/HfwB35rn/Chat-GPT-Image-18-2025-09-51-16-1.png');
  background-size: contain;
  background-repeat: no-repeat;
  z-index: 1100;
}

#zoomMenu button {
  background: #444;
  border: none;
  color: white;
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 4px;
  cursor: pointer;
}
#zoomMenu button:hover {
  background: #666;
}
</style>
</head>
<body>
<!-- Кнопка возврата к местоположению -->
<button id="returnToLocationBtn" title="До мого місцерозташування"></button>
<div id="map"></div>
<!-- Контекстное меню MinimalBlack -->
<button id="mapContextBtn" title="Підложка карти"></button>
<div class="minimal-black-menu" id="mapContextMenu">
<button data-style="dark">Темна</button>
<button data-style="streets">Вулиці</button>
<button data-style="satellite">Супутник</button>
</div>
<!-- Панель информации -->
<div class="info-panel" id="infoPanel">
<div id="helipadMiniMap"></div>
<h2 id="helipadTitle"></h2>
<p id="helipadDescription"></p>
<button class="close-btn" onclick="document.getElementById('infoPanel').style.display='none'">Закрити</button>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map', { minZoom: 4 }).setView([49.95, 23.2], 10);
  const tileLayers = {
    dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: 'CARTO', subdomains: 'abcd', maxZoom: 19
    }),
    streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }),
    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'ESRI', maxZoom: 19
    })
  };
  tileLayers.dark.addTo(map);

  const rawHelipads = [];

  const infoPanel = document.getElementById('infoPanel');
  const helipadTitle = document.getElementById('helipadTitle');
  const helipadDescription = document.getElementById('helipadDescription');
  let miniMap;

  function showMiniMap(lat, lng) {
    if (miniMap) miniMap.remove();
    miniMap = L.map('helipadMiniMap', {
      attributionControl: false, zoomControl: false, dragging: false,
      scrollWheelZoom: false, doubleClickZoom: false, boxZoom: false, keyboard: false
    }).setView([lat, lng], 17);
    tileLayers.satellite.addTo(miniMap);
  }

  const customIcon = new L.Icon({
    iconUrl: 'https://i.ibb.co/Lz8FnQxK/helipadicon.png',
    iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
  });

  // Кнопка и меню
  const mapContextBtn = document.getElementById('mapContextBtn');
  const mapContextMenu = document.getElementById('mapContextMenu');

  mapContextBtn.addEventListener('click', () => {
    mapContextMenu.style.display = mapContextMenu.style.display === 'flex' ? 'none' : 'flex';
  });

  document.querySelectorAll('#mapContextMenu button').forEach(btn => {
    btn.addEventListener('click', () => {
      const selected = btn.getAttribute('data-style');
      Object.values(tileLayers).forEach(layer => map.removeLayer(layer));
      tileLayers[selected].addTo(map);
      mapContextMenu.style.display = 'none';
    });
  });

  // Метка местоположения
  const myLocationIcon = L.icon({
    iconUrl: 'https://i.ibb.co/9HCj2p70/Chat-GPT-Image-18-2025-09-51-16.png',
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40]
  });

  const myLocationLatLng = [49.95, 23.2];
  
navigator.geolocation.getCurrentPosition(function(position) {
  const myLocationLatLng = [position.coords.latitude, position.coords.longitude];
  let currentZoom = map.getZoom();

  function createScaledIcon(zoom) {
    const scale = zoom / 13;
    const size = Math.max(20, 40 * scale);
    return L.icon({
      iconUrl: 'https://i.ibb.co/9HCj2p70/Chat-GPT-Image-18-2025-09-51-16.png',
      iconSize: [size, size],
      iconAnchor: [size / 2, size],
      popupAnchor: [0, -size / 2],
      className: 'glow'
    });
  }

  const myMarker = L.marker(myLocationLatLng, {
    icon: createScaledIcon(currentZoom)
  }).addTo(map);

  map.setView(myLocationLatLng, 13);

  map.on('zoom', () => {
    const newZoom = map.getZoom();
    if (newZoom !== currentZoom) {
      currentZoom = newZoom;
      myMarker.setIcon(createScaledIcon(currentZoom));
    }
  });
});

  map.setView(myLocationLatLng, 13);
</script>
<script>
// Обработчик кнопки возврата к местоположению
const returnBtn = document.getElementById('returnToLocationBtn');
returnBtn.addEventListener('click', () => {
  if (myMarker) {
    map.setView(myMarker.getLatLng(), 13);
  }
});
</script>
<div id="zoomMenu" style="position:absolute; top:10px; right:10px; background:rgba(30,30,30,0.95); border-radius:8px; padding:6px; z-index:1100; display:flex; gap:6px;">
<button data-label="1" data-zoom="13">1 км</button>
<button data-label="5" data-zoom="11">5 км</button>
<button data-label="10" data-zoom="10">10 км</button>
<button data-label="20" data-zoom="9">20 км</button>
<button data-label="50" data-zoom="8">50 км</button>
</div>

<div id="scaleText" style="position:absolute; bottom:10px; right:10px; color:white; background:rgba(0,0,0,0.5); padding:4px 8px; font-size:13px; border-radius:6px; z-index:1100;">
  Масштаб...
</div>
<script>
let myMarker = null;
let labelOverride = null;

function createScaledIcon(zoom) {
  const scale = zoom / 13;
  const size = Math.max(20, 40 * scale);
  return L.icon({
    iconUrl: 'https://i.ibb.co/9HCj2p70/Chat-GPT-Image-18-2025-09-51-16.png',
    iconSize: [size, size],
    iconAnchor: [size / 2, size],
    popupAnchor: [0, -size / 2],
    className: 'glow'
  });
}

navigator.geolocation.watchPosition(function(position) {
  const latlng = [position.coords.latitude, position.coords.longitude];

  if (!myMarker) {
    myMarker = L.marker(latlng, {
      icon: createScaledIcon(map.getZoom())
    }).addTo(map);
    map.setView(latlng, 13);

    map.on('zoom', () => {
      myMarker.setIcon(createScaledIcon(map.getZoom()));
    });
  } else {
    myMarker.setLatLng(latlng);
  }
});

window.addEventListener('DOMContentLoaded', () => {
  L.control.scale({ imperial: false }).addTo(map);

  const pixelsPerCm = 37.8;

  function getKmPerCm(zoom, lat) {
    const metersPerPixel = 40075016.686 * Math.cos(lat * Math.PI / 180) / Math.pow(2, zoom + 8);
    const metersPerCm = metersPerPixel * pixelsPerCm;
    return metersPerCm / 1000;
  }

  function updateScaleLabel() {
    const el = document.getElementById('scaleText');
    if (labelOverride !== null) {
      el.textContent = `1 см ≈ ${labelOverride} км`;
    } else {
      const center = map.getCenter();
      const zoom = map.getZoom();
      const kmPerCm = getKmPerCm(zoom, center.lat);
      const rounded = Math.ceil(kmPerCm);
      el.textContent = `1 см ≈ ${rounded} км`;
    }
  }

  document.querySelectorAll('#zoomMenu button').forEach(btn => {
    btn.addEventListener('click', () => {
      const zoomLevel = parseInt(btn.getAttribute('data-zoom'));
      const label = btn.getAttribute('data-label');
      labelOverride = label;
      map.setZoom(zoomLevel);
    });
  });

  map.on('zoomend', () => {
    const zoomNow = map.getZoom();
    const matched = Array.from(document.querySelectorAll('#zoomMenu button')).some(btn => {
      return parseInt(btn.getAttribute('data-zoom')) === zoomNow;
    });

    if (!matched) {
      labelOverride = null;
    }

    updateScaleLabel();
  });

  map.on('moveend', updateScaleLabel);
  updateScaleLabel();

  const returnBtn = document.getElementById('returnToLocationBtn');
  if (returnBtn) {
    returnBtn.addEventListener('click', () => {
      if (myMarker) {
        map.setView(myMarker.getLatLng(), map.getZoom());
        labelOverride = null;
        updateScaleLabel();
      }
    });
  }
});
</script></body>
</html>
